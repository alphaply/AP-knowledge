{% extends 'base.html' %}
{% load mptt_tags %}

{% block content %}
<div class="row">
    <div class="col-md-3 d-none d-md-block">
        <div class="list-group sticky-top" style="top: 20px;">
            <div class="list-group-item bg-light fw-bold">目录导航</div>
            {% recursetree root_categories %}
                <div class="list-group-item border-0 p-1 ps-3">
                    {{ node.name_zh }}
                    {% if not node.is_leaf_node %}
                         <div class="ms-2 border-start ps-2">{{ children }}</div>
                    {% endif %}
                </div>
            {% endrecursetree %}
        </div>
    </div>

    <div class="col-md-9">
        <div class="card shadow-sm p-4 mb-4">
            <h1 class="mb-3">{{ article.title }}</h1>

            <div class="d-flex justify-content-between mb-4 border-bottom pb-2">
                <div class="text-muted small">
                    分类: {{ article.category.name_zh }} | 更新: {{ article.updated_at|date:"Y-m-d" }}
                </div>
                <div>
                    {% for trans in translations %}
                        <a href="{% url 'doc_detail' trans.id %}" class="badge bg-primary text-decoration-none">
                            {{ trans.get_language_display }}
                        </a>
                    {% endfor %}
                </div>
            </div>

            <div class="markdown-body">
                {{ article.content_html|safe }}
            </div>

            {% if article.attachment %}
            <div class="alert alert-info mt-4 d-flex align-items-center">
                <i class="bi bi-paperclip fs-3 me-3"></i>
                <div>
                    <strong>附件下载：</strong>
                    <a href="{{ article.attachment.url }}" target="_blank" class="text-decoration-underline">
                        {{ article.filename }}
                    </a>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="card shadow-sm p-4">
            <h4 class="mb-4">文章评论</h4>

            {% for comment in comments %}
            <div class="d-flex mb-3 border-bottom pb-3">
                <div class="flex-shrink-0">
                    <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        {{ comment.nickname|slice:":1" }}
                    </div>
                </div>
                <div class="flex-grow-1 ms-3">
                    <h6 class="mt-0 fw-bold">{{ comment.nickname }} <small class="text-muted fw-normal">{{ comment.created_at|date:"Y-m-d H:i" }}</small></h6>
                    <p class="mb-1">{{ comment.content }}</p>

                    {% if comment.admin_reply %}
                    <div class="alert alert-success py-2 mt-2 mb-0">
                        <i class="bi bi-person-badge-fill me-1"></i>
                        <strong>管理员回复：</strong> {{ comment.admin_reply }}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <p class="text-muted">暂无评论，欢迎留言！</p>
            {% endfor %}

            <hr>
            <h5 class="mb-3">发表评论</h5>
            <form method="post" class="row g-3">
                {% csrf_token %}
                <div class="col-md-6">
                    {{ comment_form.nickname }}
                </div>
                <div class="col-12">
                    {{ comment_form.content }}
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        {{ comment_form.captcha }}
                    </div>
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">提交评论</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}